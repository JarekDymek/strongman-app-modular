<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Strongman NextGen Modular</title>
  
  <!-- ZaleÅ¼noÅ›ci zewnÄ™trzne -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- Link do zewnÄ™trznego arkusza stylÃ³w -->
  <link rel="stylesheet" href="css/main.css">
  
  <!-- Link do manifestu PWA -->
  <link rel="manifest" href="manifest.json">

</head>
<body>

  <!-- Pasek powiadomieÅ„ i wskaÅºnik zapisu -->
  <div id="notification-bar"></div>
  <div id="saveIndicator">ğŸ’¾</div>

  <!-- --- SEKCJA MODALI --- -->
  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-box">
      <p id="modalText"></p>
      <div class="modal-buttons">
        <button id="confirmBtn">Tak</button> <button id="cancelBtn">Anuluj</button>
      </div>
    </div>
  </div>

  <!-- === NOWY MODAL DO EDYCJI EKSPORTU === -->
  <div id="editExportModal" class="modal-overlay">
    <div class="modal-box" style="max-width: 90vw; width: 800px;">
        <h3>Edytuj Raport Przed Eksportem</h3>
        <div id="editable-content" contenteditable="true" style="border: 1px solid #ccc; padding: 15px; min-height: 40vh; text-align: left; background: #fff; color: #000;">
            <!-- TreÅ›Ä‡ raportu zostanie tutaj wstawiona -->
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button id="saveAndDownloadBtn">Zapisz i Pobierz</button>
            <button id="cancelExportBtn" style="background: var(--error-color);">Anuluj</button>
        </div>
    </div>
  </div>
  <!-- === KONIEC NOWEGO MODALA === -->

  <div id="promptModal" class="modal-overlay">
      <div class="modal-box">
          <p id="promptText"></p>
          <input type="text" id="promptInput" style="margin-top: 10px; margin-bottom: 20px;">
          <div class="modal-buttons">
              <button id="promptConfirmBtn">OK</button>
              <button id="promptCancelBtn">Anuluj</button>
          </div>
      </div>
  </div>
  
  <div id="geminiModal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="geminiModalTitle">âœ¨ Sugestie od Gemini</h3>
      <div id="geminiLoading" style="display: none; font-size: 1.2rem; padding: 20px 0;">Generowanie...</div>
      <div id="geminiOutput"></div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="geminiCloseBtn">Zamknij</button>
      </div>
    </div>
  </div>

  <div id="competitorDetailModal" class="modal-overlay">
      <div class="modal-box" onclick="event.stopPropagation()">
          <h3 id="competitorDetailName" style="text-align: center;"></h3>
          <img id="competitorDetailPhoto" src="" alt="ZdjÄ™cie zawodnika">
          <div id="competitorDetailMeta"></div>
          <h4>OsiÄ…gniÄ™cia / Notatki:</h4>
          <p id="competitorDetailNotes"></p>
          <button id="competitorDetailCloseBtn" style="font-size: 16px; padding: 10px;">Zamknij</button>
      </div>
  </div>

  <div id="competitorDbPanel" class="modal-overlay">
    <div class="modal-box">
      <h2>Baza Danych ZawodnikÃ³w</h2>
      <form id="competitorForm">
        <input type="hidden" id="competitorId">
        <label for="competitorNameInput">ImiÄ™ i nazwisko</label>
        <input type="text" id="competitorNameInput" placeholder="ImiÄ™ i nazwisko" required>
        <div class="form-grid">
            <div><label for="birthDateInput">Data urodzenia</label><input type="date" id="birthDateInput"></div>
            <div><label for="residenceInput">M-ce zamieszkania</label><input type="text" id="residenceInput" placeholder="np. Malbork"></div>
        </div>
        <div class="form-grid">
            <div><label for="heightInput">Wzrost (cm)</label><input type="number" id="heightInput" placeholder="np. 185"></div>
            <div><label for="weightInput">Waga (kg)</label><input type="number" id="weightInput" placeholder="np. 140"></div>
        </div>
        <label>Kategorie</label>
        <div id="competitorCategories" class="categories-checkbox-group">
          <!-- Kategorie bÄ™dÄ… generowane dynamicznie -->
        </div>
        <label for="competitorNotesInput">OsiÄ…gniÄ™cia / Notatki</label>
        <textarea id="competitorNotesInput" placeholder="GÅ‚Ã³wne osiÄ…gniÄ™cia, rekordy..."></textarea>
        <label for="competitorPhotoInput">ZdjÄ™cie</label>
        <input type="file" id="competitorPhotoInput" accept="image/*">
        <button type="submit" id="competitorFormBtn">Dodaj Zawodnika</button>
      </form>
      <div id="competitorListContainer"></div>
      <div id="dbManagementButtons">
        <button id="exportDbBtn" style="background: var(--info-color); color: var(--dark-gray);">Eksportuj BazÄ™</button>
        <button id="importDbTrigger" style="background: var(--info-color); color: var(--dark-gray);">Importuj BazÄ™</button>
        <input type="file" id="importDbFile" accept=".json" style="display:none;">
      </div>
      <button id="closeDbPanelBtn" style="background: var(--primary-color); margin-top: 20px;">Zamknij Panel</button>
    </div>
  </div>

  <div id="eventDbPanel" class="modal-overlay">
    <div class="modal-box">
        <h2>Baza Danych Konkurencji</h2>
        <form id="eventForm">
            <input type="hidden" id="eventId">
            <label for="eventNameDbInput">Nazwa konkurencji</label>
            <input type="text" id="eventNameDbInput" placeholder="np. Spacer Farmera" required>
            <label for="eventTypeDbInput">Zasada punktacji</label>
            <select id="eventTypeDbInput" required>
                <option value="high">WiÄ™cej = Lepiej (np. powtÃ³rzenia)</option>
                <option value="low">Mniej = Lepiej (np. czas)</option>
            </select>
            <button type="submit" id="eventFormBtn">Dodaj KonkurencjÄ™</button>
        </form>
        <div id="eventListContainer"></div>
        <div id="eventDbManagementButtons">
            <button id="exportEventsDbBtn" style="background: var(--info-color); color: var(--dark-gray);">Eksportuj BazÄ™</button>
            <button id="importEventsDbTrigger" style="background: var(--info-color); color: var(--dark-gray);">Importuj BazÄ™</button>
            <input type="file" id="importEventsDbFile" accept=".json" style="display:none;">
        </div>
        <button id="closeEventDbPanelBtn" style="background: var(--primary-color); margin-top: 20px;">Zamknij</button>
    </div>
  </div>

    <div id="selectEventModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Wybierz konkurencjÄ™ z bazy</h3>
        <div id="selectEventList"></div>
        <button id="selectEventCancelBtn" style="background-color: var(--error-color);">Anuluj</button>
    </div>
  </div>

  <div id="focusModeModal" class="modal-overlay">
      <div class="modal-box focus-mode-box">
          <button id="closeFocusBtn" class="focus-close-btn" aria-label="Zamknij tryb skupienia">Ã—</button>
          <div id="focusCompetitorInfo">
              <img id="focusCompetitorPhoto" src="" alt="ZdjÄ™cie zawodnika">
              <h3 id="focusCompetitorName"></h3>
          </div>
          <input type="text" inputmode="decimal" id="focusResultInput" placeholder="Wpisz wynik...">
          <div class="focus-nav-buttons">
              <button id="focusPrevBtn">Poprzedni</button>
              <button id="focusConfirmNextBtn">ZatwierdÅº i NastÄ™pny</button>
              <button id="focusNextBtn">NastÄ™pny</button>
          </div>
      </div>
  </div>
    
  <div id="fsLapsModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Wybierz wynik do zapisu</h3>
        <div id="fsLapsModalList"></div>
        <button id="fsLapsCancelBtn" style="background-color: var(--error-color);">Anuluj</button>
    </div>
  </div>


  <div id="fullscreenStopwatch">
    <a href="#" id="fsExitBtn">Ã—</a>
    <div id="fsDisplayArea">
      <div id="fsTime">00:00.00</div>
      <img id="fsCompetitorPhoto" src="" alt="ZdjÄ™cie zawodnika">
      <div id="fsCompetitorName">Zawodnik</div>
    </div>
    <div id="fsControls">
      <div id="fsModeSelection">
        <button id="fsRepsBtn" class="fs-btn">PowtÃ³rzenia</button>
        <button id="fsLapsBtn" class="fs-btn">MiÄ™dzyczasy</button>
      </div>
      <button id="fsStartStopBtn" class="fs-btn">Start</button>
      <div id="fsPostStopControls">
        <button id="fsResetBtn" class="fs-btn">Reset</button>
        <button id="fsSaveBtn" class="fs-btn">Zapisz</button>
      </div>
    </div>
  </div>


  <!-- --- GÅÃ“WNA ZAWARTOÅšÄ† STRONY --- -->
  <div class="theme-selector">
    <label for="themeSelector">Motyw:</label>
    <select id="themeSelector">
      <option value="light">Jasny</option>
      <option value="dark">Ciemny</option>
      <option value="contrast">Kontrastowy</option>
    </select>
  </div>

  <div class="event-meta-header">
    <div class="event-meta-inputs">
      <input type="text" id="eventNameInput" placeholder="Nazwa zawodÃ³w" value="PUCHAR POLSKI &quot;TYBERIAN TEAM&quot;">
      <input type="text" id="eventLocationInput" placeholder="Lokalizacja zawodÃ³w">
    </div>
    <div class="actions-grid" style="grid-template-columns: 1fr 1fr auto;">
        <button id="manageDbBtn">ZarzÄ…dzaj Zawodnikami</button>
        <button id="manageEventsDbBtn">ZarzÄ…dzaj Konkurencjami</button>
        <button id="generateEventNameBtn" class="gemini-btn" title="Zaproponuj nazwÄ™ zawodÃ³w">âœ¨</button>
    </div>
  </div>

  <header class="header">
    <div class="logo-container">
      <img id="logoImg" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzJjM2U1MCIgd2lkdGg9IjE1MHB4IiBoZWlnaHQ9IjE1MHB4Ij48cGF0aCBkPSJNMjIgMTJoLTJ2LTJoLTJ2LTJoLTJ2Mkg4di0ySDZ2MkgydjJoMlYxNGgydjJoMnYyaDJ2LTJoMnYtMmgydjJoMnYtMmgydjJoMnYtMmgydi0yaC0yem0tMTAgNmMtMS4xIDAtMi0uOS0yLTJzLjktMiAyLTIgMiAuOSAyIDJzLS45IDItMiAyetTTE2IDhjMCAxLjEtLjkgMi0yIDJoLTRjLTEuMSAwLTItLjktMi0yVjZoMHYyYzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMVY2aDJ2MmMwIC41NS40NSAxIDEgMXMxLS40NSAxLTFWNmgwdjJ6Ii8+PC9zdmc+" alt="Logo zawodÃ³w">
      <div class="logo-actions">
        <button id="selectLogoBtn" class="logo-btn">Wybierz Logo</button>
      </div>
      <input type="file" id="logoUpload" accept="image/*" style="display:none">
    </div>
    <h1>ğŸ‹ï¸â€â™‚ï¸ ZAWODY STRONGMAN ğŸ‹ï¸â€â™€ï¸</h1>
    <p>System ZarzÄ…dzania NextGen - Wersja ModuÅ‚owa</p>
  </header>

  <main id="intro" class="view">
    <div class="intro-container">
      <h2>Wybierz ZawodnikÃ³w</h2>
      <p>Filtruj wg kategorii, aby zawÄ™ziÄ‡ listÄ™. Wybory sÄ… zachowywane pomiÄ™dzy filtrami.</p>
      <div class="filter-buttons" id="categoryFilters">
        <button class="filter-btn active" data-filter="all">Wszyscy</button>
      </div>
      <div id="competitorSelectionList">
        <p>Åadowanie zawodnikÃ³w z bazy danych...</p>
      </div>
      <div id="selectionCounter">Wybrano: 0</div>
      <div id="competitorSearchContainer">
        <input type="text" id="competitorSearch" placeholder="Wyszukaj i dodaj zawodnika z bazy...">
        <div id="competitorSearchResults"></div>
      </div>
      <h3>...lub wklej listÄ™ zawodnikÃ³w</h3>
      <textarea id="pastedCompetitors" placeholder="Wklej listÄ™ zawodnikÃ³w, jeden w kaÅ¼dej linii..."></textarea>
      <button id="addPastedBtn">Dodaj ZawodnikÃ³w z Listy</button>

      <div class="security-panel">
        <h3>ğŸ›¡ï¸ Zabezpieczenia Przed Startem</h3>
        <div class="button-group">
          <button id="exportStateBtn_intro">Eksportuj Stan do Pliku</button>
          <button id="importStateBtn_intro">Importuj Stan z Pliku</button>
        </div>
        <input type="file" id="importFile_intro" accept=".json" style="display:none;">
      </div>
      <button id="startCompetitionBtn">Rozpocznij Zawody</button>
    </div>
  </main>

  <main id="mainContent" class="view" style="display:none;">
    <div class="event-title-container">
      <div id="eventTitle" contenteditable="true">Konkurencja 1</div>
      <button id="selectEventFromDbBtn" title="Wybierz konkurencjÄ™ z bazy">ğŸ“‚</button>
      <button id="generateAnnounceBtn" class="gemini-btn-small" title="Generuj zapowiedÅº konkurencji (AI Gemini)">âœ¨</button>
    </div>
    <div class="event-type-container">
        <button id="highTypeBtn" class="type-btn active" data-type="high">â¬†ï¸ WiÄ™cej = Lepiej</button>
        <button id="lowTypeBtn" class="type-btn" data-type="low">â¬‡ï¸ Mniej = Lepiej</button>
    </div>
    <div class="actions-grid">
      <button id="shuffleBtn">Pomieszaj</button>
      <button id="showResultsBtn">Wyniki</button>
      <button id="nextEventBtn">NastÄ™pna Konkurencja</button>
      <button id="finalEventBtn">Konkurencja FinaÅ‚owa</button>
      <button id="calculatePointsBtn">Przyznaj Punkty</button>
      <button id="showFinalSummaryBtn">Podsumowanie</button>
    </div>
    <button id="toggleTableWidthBtn">RozwiÅ„ TabelÄ™</button>
    <div class="table-wrapper">
        <table id="resultsTable">
          <thead>
            <tr><th>Zawodnik</th><th>Wynik</th><th>Miejsce</th><th>Pkt.</th><th>Suma</th></tr>
          </thead>
          <tbody></tbody>
        </table>
    </div>
    <div id="undo-redo-container">
        <button id="undoBtn" disabled>Cofnij</button>
        <button id="redoBtn" disabled>PonÃ³w</button>
    </div>
    <div class="panel" id="historyPanel" style="display:none;">
      <h3>Historia Konkurencji</h3>
      <div id="eventList"></div>
      <div class="panel" id="eventDetails"></div>
    </div>
    <div id="export-button-group" style="grid-template-columns: repeat(3, 1fr);">
            <button id="exportHtmlBtn">Eksportuj jako HTML</button>
      <button id="resetCompetitionBtn" style="background:var(--error-color)">Resetuj</button>
    </div>
    <div class="panel security-panel">
        <h3>ğŸ›¡ï¸ Zabezpieczenia i Kopie Zapasowe</h3>
        <div class="button-group">
            <button id="saveCheckpointBtn">Zapisz Punkt Kontrolny</button>
            <button id="showCheckpointsBtn">Wczytaj Punkt Kontrolny</button>
            <button id="exportStateBtn_main">Eksportuj Stan do Pliku</button>
            <button id="importStateBtn_main">Importuj Stan z Pliku</button>
        </div>
        <input type="file" id="importFile_main" accept=".json" style="display:none;">
        <div id="checkpointListContainer" style="display:none; margin-top:15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4>DostÄ™pne punkty kontrolne:</h4>
              <strong id="storageUsage"></strong>
            </div>
            <div id="checkpointList"></div>
        </div>
    </div>
  </main>
  
  <!-- Ukryty kontener do generowania PDF/Obrazu -->
  <div id="pdf-export-container" style="position: absolute; left: -9999px; width: 800px; background: white; padding: 20px; color: black;"></div>

  <!-- GÅ‚Ã³wny skrypt aplikacji -->
  <script type="module" src="js/main.js"></script>

  <!-- Skrypt rejestrujÄ…cy Service Worker dla PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>

</body>
</html>
